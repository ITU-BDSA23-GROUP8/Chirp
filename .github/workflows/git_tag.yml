name: .NET git_tag

on:
  push:
    branches: 
    - workflow
    tags: 
    -  '*'

jobs:
    build:
        runs-on: ubuntu-latest
    
        steps:
        - uses: actions/checkout@v3
        - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
            dotnet-version: 7.0.x
        - name: Restore dependencies
        run: dotnet restore
        - name: Build
        run: dotnet build --no-restore
        - name: Test
        run: dotnet test --no-build --verbosity normal
                


    release:
        name: Release
        strategy:
            matrix:
                kind: ['linux', 'windows', 'macOS']
                include:
                    - kind: linux
                    os: ubuntu-latest
                    target: linux-x64
                    - kind: windows
                    os: windows-latest
                    target: win-x64
                    - kind: macOS
                    os: macos-latest
                    target: osx-x64
        runs-on: ${{ matrix.os }}
        steps:
            - name: Checkout
            uses: actions/checkout@v1

            - name: Setup dotnet
            uses: actions/setup-dotnet@v1
            with:
                dotnet-version: 7.0.x

            - name: Build
            shell: bash
            run: |
                tag=$(git describe --tags --abbrev=0)
                release_name="Chirp.CLI-$tag-${{ matrix.target }}"

                # Build everything
                dotnet publish src/Chirp.CLI/Chirp.CLI.csproj --framework netcoreapp3.1 --runtime "${{ matrix.target }}" -c Release -o "$release_name"

                # Pack files
                if [ "${{ matrix.target }}" == "win-x64" ]; then
                    # Pack to zip for Windows
                    7z a -tzip "${release_name}.zip" "./${release_name}/*"
                else
                tar czvf "${release_name}.tar.gz" "$release_name"
                fi

                # Delete output directory
                rm -r "$release_name"

            - name: Publish
            uses: softprops/action-gh-release@v1
            with:
                files: "App*"
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    

       
  